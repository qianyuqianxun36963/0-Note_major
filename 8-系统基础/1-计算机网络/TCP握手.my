<h1>TCP握手</h1>

<h2>TCP三次握手</h2>

<p>一、什么是三次握手</p>

<p>三次握手(Three-way Handshake)，是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。</p>

<p>二、三次握手的目的</p>

<p>三次握手的目的是连接服务器指定端口，建立TCP连接,并同步连接双方的序列号和确认号并交换 TCP 窗口大小信息。客户端执行连接请求时。将触发三次握手。</p>

<p>三、三次握手过程</p>

<p><img alt="" src="http://www.nginx.cn/wp-content/uploads/2017/09/20170902193737_32965.png" style="height:363px; width:583px" /></p>

<p>第一次握手:<br />
客户端发送一个TCP的SYN标志位置1的包指明客户打算连接的服务器的端口，以及初始序号X,保存在包头的序列号(Sequence Number)字段里。<br />
第二次握手:<br />
服务器发回确认包(ACK)应答。即SYN标志位和ACK标志位均为1同时，将确认序号(Acknowledgement Number)设置为客户的ISN加1以.即X+1。<br />
第三次握手.<br />
客户端再次发送确认包(ACK) SYN标志位为0,ACK标志位为1。如果正确则连接建立成功，客户端和服务器进入ESTABLISHED状态，完成三次握手，随后客户端与服务器之间可以开始传输数据了。把服务器发来ACK的序号字段+1,放在确定字段中发送给对方.并且在数据段放写ISN的+1。</p>

<h2>TCP四次挥手</h2>

<p>一、什么是四次挥手</p>

<p>TCP的连接的拆除需要发送四个包，因此称为四次挥手(four-way handshake)。客户端或服务器均可主动发起挥手动作，任何一方执行close操作即可产生挥手操作。</p>

<p>二、四次挥手过程</p>

<p><img alt="" src="http://www.nginx.cn/wp-content/uploads/2017/09/20170902194556_66476.png" style="height:400px; width:613px" /></p>

<p>第一次挥手：</p>

<p>客户端发送一个FIN，用来关闭客户端到服务器的数据传送，客户机进入FIN_WAIT_1状态。<br />
第二次挥手：</p>

<p>服务器收到FIN后，发送一个ACK给客户端，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），服务器进入CLOSE_WAIT状态。<br />
第三次挥手：</p>

<p>服务器发送一个FIN，用来关闭服务器到客户端的数据传送，服务器进入LAST_ACK状态。<br />
第四次挥手：</p>

<p>客户端收到FIN后，客户端进入TIME_WAIT状态，接着发送一个ACK给服务器，确认序号为收到序号+1，服务器进入CLOSED状态，完成四次挥手。</p>

<p>有限状态机FSM:Finite State Machine</p>

<p>1、CLOSED 没有任何连接状态</p>

<p>2、LISTEN 侦听状态，等待来自远方TCP端口的连接请求</p>

<p>3 、SYN-SENT 在发送连接请求后，等待对方确认</p>

<p>4、SYN-RECEIVED 在收到和发送一个连接请求后，等待对方确认</p>

<p>5、ESTABLISHED 代表传输连接建立，双方进入数据传送状态</p>

<p>6、FIN-WAIT-1 主动关闭,主机已发送关闭连接请求，等待对方确认</p>

<p>7 、FIN-WAIT-2 主动关闭,主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求</p>

<p>8、 TIME-WAIT 完成双向传输连接关闭，等待所有分组消失</p>

<p>9、CLOSE-WAIT 被动关闭,收到对方发来的关闭连接请求，并已确认</p>

<p>10、LAST-ACK 被动关闭,等待最后一个关闭传输连接确认，并等待所有分组消失</p>

<p>11、CLOSING 双方同时尝试关闭传输连接，等待对方确认</p>

<p>附加问题：</p>

<p>【问题1】为什么连接的时候是三次握手，关闭的时候却是四次挥手？</p>

<p>答：因为当服务器收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来回应的，SYN报文是用来同步的。但是关闭连接时，当服务器收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，&rdquo;发送的FIN报文已经收到&rdquo;。只有等到客户端所有的报文都发送完了，客户端才能发送FIN报文，因此不能一起发送。故需要四步挥手。</p>

<p>【问题2】为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态？</p>

<p>答：四个报文都发送完毕，客户端和服务器可以直接进入CLOSE状态了，但有可能最后一个ACK丢失。所以TIME_WAIT状态就是用来重发可能丢失的ACK报文，确保之前的数据不会丢失后再进入close状态。</p>
